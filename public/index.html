<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Game Lobby</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="lobby-modern.css">
    <link rel="stylesheet" href="character-panel.css">
</head>
<body>

<script>
  // Debug authentication flow
  console.log('Index page loaded');
  
  document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('token');
    const userStr = localStorage.getItem('user');
    
    console.log('Token exists:', !!token);
    console.log('User exists:', !!userStr);
    
    if (!token || !userStr) {
      console.log('No authentication, redirecting to login page');
      window.location.href = '/login.html';
    } else {
      console.log('Auth tokens found, proceeding to game initialization');
      try {
        // Log parsed user data
        const userData = JSON.parse(userStr);
        console.log('User data parsed successfully:', userData);
      } catch (e) {
        console.error('Error parsing user data:', e);
      }
    }
  });
</script>

<div id="app">
    <!-- Login Screen -->
    <div id="login-screen" class="screen">
        <div class="container">
            <h1>Multiplayer Game</h1>
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" placeholder="Enter your username">
            </div>
            <div class="form-group">
                <label>Select Avatar:</label>
                <div class="avatar-selection">
                    <img src="images/avatar1.png" class="avatar-option selected" data-avatar="avatar1.png">
                    <img src="images/avatar2.png" class="avatar-option" data-avatar="avatar2.png">
                    <img src="images/avatar3.png" class="avatar-option" data-avatar="avatar3.png">
                </div>
            </div>
            <button id="login-btn">Enter Lobby</button>
        </div>
    </div>

    <!-- Modern Lobby Screen -->
    <div id="lobby-screen" class="screen hidden">
        <div class="modern-lobby">
            <!-- Left Sidebar - Navigation and Player List -->
            <div class="lobby-sidebar">
                <div class="logo-container">
                    <h1 class="game-logo">MULTIPLAYER ARENA</h1>
                </div>
                
                <nav class="lobby-nav">
                    <button class="nav-item active">
                        <i class="icon-users"></i>
                        <span>LOBBY</span>
                    </button>
                    <button class="nav-item" id="profile-btn">
                        <i class="icon-user"></i>
                        <span>PROFILE</span>
                    </button>
                    <button class="nav-item" id="open-shop-btn">
                        <i class="icon-shop"></i>
                        <span>SHOP</span>
                    </button>
                    <button class="nav-item" id="open-inventory-btn">
                        <i class="icon-inventory"></i>
                        <span>INVENTORY</span>
                    </button>
                    <button class="nav-item" id="logout-btn">
                        <i class="icon-logout"></i>
                        <span>LOGOUT</span>
                    </button>
                </nav>
                
                <div class="player-list-container">
                    <h2>ONLINE PLAYERS</h2>
                    <div id="players-container" class="modern-players-list">
                        <!-- Players will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Main Content Area -->
            <div class="lobby-main">
                <div class="lobby-header">
                    <div class="server-status">
                        <span class="status-indicator online"></span>
                        <span class="server-name">Server: US-EAST-01</span>
                        <span class="player-count">Players Online: 0</span>
                    </div>
                </div>
                
                <div class="lobby-content">
                    <!-- Challenges Section -->
                    <div class="content-card challenges-card">
                        <div class="card-header">
                            <h2>INCOMING CHALLENGES</h2>
                        </div>
                        <div class="card-body">
                            <div id="incoming-challenges">
                                <!-- Incoming challenges will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="content-card outgoing-card">
                        <div class="card-header">
                            <h2>OUTGOING CHALLENGES</h2>
                        </div>
                        <div class="card-body">
                            <div id="outgoing-challenges">
                                <!-- Outgoing challenges will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats & Activity Section -->
                    <div class="content-card stats-card">
                        <div class="card-header">
                            <h2>YOUR STATS</h2>
                        </div>
                        <div class="card-body stats-container">
                            <div class="stat-item">
                                <div class="stat-value wins-count">0</div>
                                <div class="stat-label">WINS</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value losses-count">0</div>
                                <div class="stat-label">LOSSES</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value winrate-value">0%</div>
                                <div class="stat-label">WIN RATE</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value rank-value-card">LVL 1</div> <!-- CLASS ADDED HERE -->
                                <div class="stat-label">RANK</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Sidebar - User Profile -->
            <div class="profile-sidebar">
                <div class="character-panel"> <!-- Use a consistent class name -->
                    <div class="character-image-preview">
                        <!-- Use a unique ID for this specific image -->
                        <img id="lobby-character-display-avatar" src="" alt="Character">
                    </div>
                    
                    <div class="equipment-grid">
                        <div class="equipment-slot-shop slot-helmet" data-slot="helmet">
                            <img src="images/slot-helmet.svg" class="slot-icon">
                            <div class="slot-name" id="equipped-helmet-name">None</div>
                        </div>
                        <div class="equipment-slot-shop slot-weapon" data-slot="weapon">
                            <img src="images/slot-sword.svg" class="slot-icon">
                            <div class="slot-name" id="equipped-weapon-name">None</div>
                        </div>
                        <div class="equipment-slot-shop slot-armor" data-slot="armor">
                            <img src="images/slot-armor.svg" class="slot-icon">
                            <div class="slot-name" id="equipped-armor-name">None</div>
                        </div>
                        <div class="equipment-slot-shop slot-shield" data-slot="shield">
                            <img src="images/slot-shield.svg" class="slot-icon">
                            <div class="slot-name" id="equipped-shield-name">None</div>
                        </div>
                        <div class="equipment-slot-shop slot-gloves" data-slot="gloves">
                            <img src="images/slot-gloves.svg" class="slot-icon">
                            <div class="slot-name" id="equipped-gloves-name">None</div>
                        </div>
                        <div class="equipment-slot-shop slot-boots" data-slot="boots">
                            <img src="images/slot-boots.svg" class="slot-icon">
                            <div class="slot-name" id="equipped-boots-name">None</div>
                        </div>
                        <div class="equipment-slot-shop slot-amulet" data-slot="amulet">
                            <img src="images/slot-amulet.svg" class="slot-icon">
                            <div class="slot-name" id="equipped-amulet-name">None</div>
                        </div>
                        <div class="equipment-slot-shop slot-ring" data-slot="ring">
                            <img src="images/slot-ring.svg" class="slot-icon">
                            <div class="slot-name" id="equipped-ring-name">None</div>
                        </div>
                    </div>
                    
                    <div class="character-stats">
                        <div class="character-name" id="player-name">Player Name</div>
                        <div class="character-class" id="player-class">Warrior Class</div>
                        
                        <div class="stat-row">
                            <span>💪 Strength</span>
                            <span class="stat-value strength-value">10</span>
                        </div>
                         <div class="stat-row">
                            <span>🏃 Agility</span>
                            <span class="stat-value agility-value">10</span>
                        </div>
                        <div class="stat-row">
                            <span>🧠 Intuition</span>
                            <span class="stat-value intuition-value">10</span>
                        </div>
                        <div class="stat-row">
                            <span>❤️ Endurance</span>
                            <span class="stat-value endurance-value">10</span>
                        </div>
                    </div>
                </div>
                 <div class="action-buttons-lobby">
                    <button class="action-button primary-action" id="find-match-btn">FIND MATCH</button>
                    <button class="action-button secondary-action" id="player-profile-detail-btn">VIEW PROFILE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen hidden">
        <div class="game-header">
            <div id="turn-timer-container">
                <span>Time: </span>
                <span id="turn-timer">30</span>
            </div>
            <h2>Game in Progress</h2>
            <button id="back-to-lobby" class="button">Return to Lobby</button>
        </div>

        <div class="game-container">
            <!-- Player 1 Character Panel -->
            <div class="character-panel player1-panel">
                <div class="character-name" id="player1-name">Player 1</div>
                <div class="health-energy-bars">
                    <div class="health-bar">
                        <div id="player1-health" class="health-fill"></div>
                    </div>
                    <div class="energy-bar">
                        <div id="player1-energy" class="energy-fill"></div>
                    </div>
                </div>
                
                <div class="game-character-display">
                    <div class="character-avatar-container">
                        <img id="player1-avatar" src="images/avatar1.png" class="character-avatar">
                    </div>
                    <div class="equipment-slot helmet-slot" title="Helmet">
                        <img src="images/slot-helmet.svg" class="slot-icon">
                        <div id="player1-helmet-name" class="equipment-name">None</div>
                    </div>
                    <div class="equipment-slot armor-slot" title="Armor">
                        <img src="images/slot-armor.svg" class="slot-icon">
                        <div id="player1-armor-name" class="equipment-name">None</div>
                    </div>
                    <div class="equipment-slot shield-slot" title="Shield">
                        <img src="images/slot-shield.svg" class="slot-icon">
                        <div id="player1-shield-name" class="equipment-name">None</div>
                    </div>
                    <div class="equipment-slot boots-slot" title="Boots">
                        <img src="images/slot-boots.svg" class="slot-icon">
                        <div id="player1-boots-name" class="equipment-name">None</div>
                    </div>
                    <div class="equipment-slot weapon-slot" title="Weapon">
                        <img src="images/slot-sword.svg" class="slot-icon">
                        <div id="player1-weapon-name" class="equipment-name">None</div>
                    </div>
                    <div class="equipment-slot amulet-slot" title="Amulet">
                        <img src="images/slot-amulet.svg" class="slot-icon">
                        <div id="player1-amulet-name" class="equipment-name">None</div>
                    </div>
                    <div class="equipment-slot gloves-slot" title="Gloves">
                        <img src="images/slot-gloves.svg" class="slot-icon">
                        <div id="player1-gloves-name" class="equipment-name">None</div>
                    </div>
                    <div class="equipment-slot ring-slot" title="Ring">
                        <img src="images/slot-ring.svg" class="slot-icon">
                        <div id="player1-ring-name" class="equipment-name">None</div>
                    </div>
                </div>
                 <!-- CHANGED: Added stats block for Player 1 -->
                <div class="character-stats in-game-stats">
                    <h3 class="stats-header">📊 Character Stats</h3>
                    <div class="stat-row">
                        <span class="stat-name">💪 STRENGTH</span>
                        <span class="stat-value" id="player1-strength-value">10</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">🏃 AGILITY</span>
                        <span class="stat-value" id="player1-agility-value">10</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">🧠 INTUITION</span>
                        <span class="stat-value" id="player1-intuition-value">10</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">❤️ ENDURANCE</span>
                        <span class="stat-value" id="player1-endurance-value">10</span>
                    </div>
                </div>
            </div>
            
            <!-- Combat Area (Middle) -->   
            <div class="combat-area-container">
                <!-- NEW WRAPPER DIV -->
                <div class="combat-main-content">
                       <div id="game-message-container" class="game-message-container">
                        <div class="game-message-wrapper">
                            <div id="msg-choose-move" class="game-message active">Select an attack and block area (auto-submits when both selected)</div>
                            <div id="msg-waiting-opponent" class="game-message">Waiting for opponent's move...</div>
                            <div id="msg-processing" class="game-message">Processing moves...</div>
                            <div id="msg-waiting-players" class="game-message">Waiting for opponent to connect...</div>
                        </div>
                    </div>
                    
                    <div class="versus-display">
                        <span>VS</span>
                    </div>
                    
                    <div id="combat-controls" class="combat-controls">
                        <div class="combat-section">
                            <h3>Attack</h3>
                            <div class="attack-areas">
                                <div class="combat-area" data-area="head">Head</div>
                                <div class="combat-area" data-area="body">Body</div>
                                <div class="combat-area" data-area="legs">Legs</div>
                            </div>
                        </div>
                        
                        <div class="combat-section">
                            <h3>Block</h3>
                            <div class="block-areas">
                                <div class="combat-area" data-area="head">Head</div>
                                <div class="combat-area" data-area="body">Body</div>
                                <div class="combat-area" data-area="legs">Legs</div>
                            </div>
                        </div>                   
                    </div>
                </div> <!-- END OF NEW WRAPPER DIV -->
                
                <div id="game-log" class="game-log"></div>
            </div>
            
            <!-- Player 2 Character Panel -->
            <div class="character-panel player2-panel">
                <div class="character-name" id="player2-name">Player 2</div>
                <div class="health-energy-bars">
                    <div class="health-bar">
                        <div id="player2-health" class="health-fill"></div>
                    </div>
                    <div class="energy-bar">
                        <div id="player2-energy" class="energy-fill"></div>
                    </div>
                </div>
                
                <div class="game-character-display">
                    <div class="character-avatar-container">
                        <img id="player2-avatar" src="images/avatar2.png" class="character-avatar">
                    </div>
                    <div class="equipment-slot helmet-slot" title="Helmet">
                        <img src="images/slot-helmet.svg" class="slot-icon">
                        <div id="player2-helmet-name" class="equipment-name">None</div>
                    </div>
                    <div class="equipment-slot armor-slot" title="Armor">
                        <img src="images/slot-armor.svg" class="slot-icon">
                        <div id="player2-armor-name" class="equipment-name">None</div>
                    </div>
                    <div class="equipment-slot shield-slot" title="Shield">
                        <img src="images/slot-shield.svg" class="slot-icon">
                        <div id="player2-shield-name" class="equipment-name">None</div>
                    </div>
                    <div class="equipment-slot boots-slot" title="Boots">
                        <img src="images/slot-boots.svg" class="slot-icon">
                        <div id="player2-boots-name" class="equipment-name">None</div>
                    </div>
                    <div class="equipment-slot weapon-slot" title="Weapon">
                        <img src="images/slot-sword.svg" class="slot-icon">
                        <div id="player2-weapon-name" class="equipment-name">None</div>
                    </div>
                    <div class="equipment-slot amulet-slot" title="Amulet">
                        <img src="images/slot-amulet.svg" class="slot-icon">
                        <div id="player2-amulet-name" class="equipment-name">None</div>
                    </div>
                    <div class="equipment-slot gloves-slot" title="Gloves">
                        <img src="images/slot-gloves.svg" class="slot-icon">
                        <div id="player2-gloves-name" class="equipment-name">None</div>
                    </div>
                    <div class="equipment-slot ring-slot" title="Ring">
                        <img src="images/slot-ring.svg" class="slot-icon">
                        <div id="player2-ring-name" class="equipment-name">None</div>
                    </div>
                </div>
                 <!-- CHANGED: Added stats block for Player 2 -->
                <div class="character-stats in-game-stats">
                    <h3 class="stats-header">📊 Opponent Stats</h3>
                     <div class="stat-row">
                        <span class="stat-name">💪 STRENGTH</span>
                        <span class="stat-value" id="player2-strength-value">10</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">🏃 AGILITY</span>
                        <span class="stat-value" id="player2-agility-value">10</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">🧠 INTUITION</span>
                        <span class="stat-value" id="player2-intuition-value">10</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">❤️ ENDURANCE</span>
                        <span class="stat-value" id="player2-endurance-value">10</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shop Screen (can be separate HTML or part of this SPA) -->
    <div id="shop-screen" class="screen hidden">
        <div class="container">
            <div class="header">
                <h1>Item Shop</h1>
                <div>
                    <span>Gold: <span id="player-gold-shop">0</span></span> 
                    <button id="back-to-lobby-from-shop" class="button">Return to Lobby</button>
                </div>
            </div>
            
            <div class="shop-container">
                <div class="shop-categories">
                    <button class="category-btn active" data-category="weapons">Weapons</button>
                    <button class="category-btn" data-category="armor">Armor</button>
                    <button class="category-btn" data-category="shields">Shields</button>
                    <button class="category-btn" data-category="helmets">Helmets</button>
                </div>
                
                <div class="shop-items" id="shop-items-container">
                    <!-- Shop items will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="challenge-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Challenge Player</h2>
            <p>Are you sure you want to challenge <span id="opponent-name"></span>?</p>
            <div class="modal-buttons">
                <button id="confirm-challenge">Challenge</button>
                <button id="cancel-challenge">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div id="inventory-modal" class="modal hidden">
        <div class="modal-content inventory-modal-content">
            <h2>Inventory</h2>
            
            <div class="equipped-items">
                <h3>Equipped</h3>
                <div class="equipment-slots">
                    <div class="equipment-slot" data-slot="weapon">
                        <div class="slot-label">Weapon</div>
                        <div class="slot-item" id="equipped-weapon">None</div>
                    </div>
                    <div class="equipment-slot" data-slot="armor">
                        <div class="slot-label">Armor</div>
                        <div class="slot-item" id="equipped-armor">None</div>
                    </div>
                    <div class="equipment-slot" data-slot="shield">
                        <div class="slot-label">Shield</div>
                        <div class="slot-item" id="equipped-shield">None</div>
                    </div>
                     <div class="equipment-slot" data-slot="helmet">
                        <div class="slot-label">Helmet</div>
                        <div class="slot-item" id="equipped-helmet">None</div>
                    </div>
                </div>
            </div>
            
            <div class="inventory-items">
                <h3>Inventory</h3>
                <div id="inventory-items-container">
                    <!-- Inventory items will be populated here -->
                </div>
            </div>
            
            <div class="player-gold-container" style="text-align: center; margin-top:10px;">
                Gold: <span id="player-gold">0</span>
            </div>
            
            <div class="modal-buttons">
                <button id="close-inventory">Close</button>
            </div>
        </div>
    </div>

    <!-- Combat Result Modal -->
    <div id="combat-result-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Round Results</h2>
            <div id="combat-result-content"></div>
            <div class="modal-buttons">
                <button id="continue-game">Continue</button>
            </div>
        </div>
    </div>
</div>

<script src="/auth.js"></script>
<script src="stats-manager.js"></script>
<!-- combat-system.js is not strictly needed on client if all logic is server-side, but kept for potential future client-side predictions -->
<!-- <script src="combat-system.js"></script> --> 
<script src="/socket.io/socket.io.js"></script>
<script src="game.js"></script>


<script src="modern-inventory.js"></script>
</body>
</html>